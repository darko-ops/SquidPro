<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - SquidPro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶ë</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f8f8f8;
            --text-primary: #000000;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-primary: #f0f0f0;
            --border-secondary: #e0e0e0;
            --accent: #00bcd4;
            --accent-hover: #00acc1;
            --success: #00c851;
            --warning: #ff9f43;
            --error: #ff5252;
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --border-primary: #2a2a2a;
            --border-secondary: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 300;
            line-height: 1.5;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Header */
        .header {
            border-bottom: 1px solid var(--border-primary);
            padding: 2rem 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Magz', 'Inter', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 400;
            transition: color 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--accent);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--border-secondary);
            color: var(--text-secondary);
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        /* Main Content */
        .main {
            padding: 3rem 0;
        }

        /* Authentication Section */
        .auth-section {
            max-width: 500px;
            margin: 0 auto;
            padding: 3rem 2rem;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* User Type Selection */
        .user-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .user-type-card {
            padding: 1.5rem 1rem;
            border: 2px solid var(--border-secondary);
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .user-type-card:hover {
            border-color: var(--accent);
        }

        .user-type-card.active {
            border-color: var(--accent);
            background: var(--accent);
            color: var(--bg-primary);
        }

        .user-type-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .user-type-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .user-type-desc {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .user-type-card.active .user-type-desc {
            opacity: 1;
        }

        .user-type-checkbox {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .selected-roles {
            text-align: center;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            font-size: 0.875rem;
        }

        #role-summary {
            color: var(--accent);
            font-weight: 500;
        }

        /* Forms */
        .form-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .form-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .form-tab.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
        }

        .form-panel {
            display: none;
        }

        .form-panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-secondary);
            background: var(--bg-primary);
            font-size: 0.9rem;
            font-family: inherit;
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }

        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .auth-btn:hover {
            background: var(--text-secondary);
        }

        .auth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Action Buttons */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--text-primary);
            background: transparent;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .user-type-grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                display: none;
            }

            .profile-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .profile-nav {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .security-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Loading states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .error {
            padding: 1rem;
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            font-size: 0.875rem;
        }

        .success {
            padding: 1rem;
            background: rgba(0, 200, 81, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">SquidPro</a>
                <div class="nav-links">
                    <a href="/" class="nav-link">Catalog</a>
                    <a href="/profile.html" class="nav-link active">Profile</a>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" id="theme-toggle">
                        <span id="theme-icon">‚òæ</span>
                    </button>
                    <div class="api-status">
                        <div class="status-dot"></div>
                        <span id="api-status-text">Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Authentication Section -->
            <div id="auth-section" class="auth-section">
                <div class="auth-header">
                    <h1 class="auth-title">Access Your Account</h1>
                    <p class="auth-subtitle">Sign in to manage your SquidPro business</p>
                </div>

                <!-- User Type Selection -->
                <div class="user-type-grid">
                    <div class="user-type-card active" id="supplier-card">
                        <span class="user-type-icon">üìä</span>
                        <div class="user-type-title">Data Supplier</div>
                        <div class="user-type-desc">Provide APIs & earn revenue</div>
                        <div class="user-type-checkbox">‚òë</div>
                    </div>
                    <div class="user-type-card" id="reviewer-card">
                        <span class="user-type-icon">üîç</span>
                        <div class="user-type-title">Validator</div>
                        <div class="user-type-desc">Review data quality & earn rewards</div>
                        <div class="user-type-checkbox">‚òê</div>
                    </div>
                    <div class="user-type-card" id="buyer-card">
                        <span class="user-type-icon">ü§ñ</span>
                        <div class="user-type-title">Agent/Buyer</div>
                        <div class="user-type-desc">Access data feeds for agents</div>
                        <div class="user-type-checkbox">‚òê</div>
                    </div>
                </div>

                <div id="selected-roles" class="selected-roles">
                    <strong>Selected roles:</strong> <span id="role-summary">Data Supplier</span>
                </div>

                <!-- Form Tabs -->
                <div class="form-tabs">
                    <div class="form-tab active" id="login-tab">Sign In</div>
                    <div class="form-tab" id="register-tab">Register</div>
                </div>

                <!-- Login Form -->
                <div id="login-panel" class="form-panel active">
                    <form id="login-form">
                        <div class="form-group">
                            <label class="form-label" for="login-key">API Key / Token</label>
                            <input 
                                type="password" 
                                id="login-key" 
                                class="form-input" 
                                placeholder="Enter your API key..."
                                required
                            >
                            <div class="form-help" id="login-help">
                                Enter your supplier API key (sup_...) or reviewer key (rev_...)
                            </div>
                        </div>
                        <button type="submit" class="auth-btn">
                            Access Dashboard
                        </button>
                    </form>
                </div>

                <!-- Registration Form -->
                <div id="register-panel" class="form-panel">
                    <form id="register-form">
                        <div class="form-group">
                            <label class="form-label" for="reg-name">Name / Organization</label>
                            <input 
                                type="text" 
                                id="reg-name" 
                                class="form-input" 
                                placeholder="Your name or company name..."
                                required
                            >
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="reg-email">Email</label>
                            <input 
                                type="email" 
                                id="reg-email" 
                                class="form-input" 
                                placeholder="your@email.com"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="reg-stellar">Stellar Address</label>
                            <input 
                                type="text" 
                                id="reg-stellar" 
                                class="form-input" 
                                placeholder="G... (for receiving payments)"
                                required
                            >
                            <div class="form-help">
                                Your Stellar address for receiving XLM/USDC payments
                            </div>
                        </div>

                        <div id="supplier-fields" class="supplier-specific">
                            <div class="form-group">
                                <label class="form-label" for="reg-description">Business Description</label>
                                <textarea 
                                    id="reg-description" 
                                    class="form-textarea" 
                                    placeholder="Describe your data services..."
                                ></textarea>
                            </div>
                        </div>

                        <div id="reviewer-fields" class="reviewer-specific hidden">
                            <div class="form-group">
                                <label class="form-label" for="reg-specializations">Specializations</label>
                                <input 
                                    type="text" 
                                    id="reg-specializations" 
                                    class="form-input" 
                                    placeholder="financial, weather, social (comma-separated)"
                                >
                                <div class="form-help">
                                    Categories you're qualified to review
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="auth-btn">
                            Create Account
                        </button>
                    </form>
                </div>

                <div class="action-grid">
                    <a href="/" class="btn">‚Üê Back to Catalog</a>
                    <button class="btn btn-primary" id="api-integration-btn">
                        API Integration
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables - MUST be at very top
        window.API_BASE = 'http://localhost:8100';
        window.currentUser = null;
        window.selectedUserTypes = ['supplier'];
        window.authMode = 'login';

        console.log('SquidPro Profile script loading...');

        // Core functions - Define immediately
        window.toggleUserType = function(type) {
            console.log('toggleUserType called with:', type);
            
            const card = document.getElementById(`${type}-card`);
            if (!card) {
                console.error('Card not found:', type);
                return;
            }
            
            const checkbox = card.querySelector('.user-type-checkbox');
            if (!checkbox) {
                console.error('Checkbox not found:', type);
                return;
            }
            
            if (window.selectedUserTypes.includes(type)) {
                // Remove role
                window.selectedUserTypes = window.selectedUserTypes.filter(t => t !== type);
                card.classList.remove('active');
                checkbox.textContent = '‚òê';
            } else {
                // Add role
                window.selectedUserTypes.push(type);
                card.classList.add('active');
                checkbox.textContent = '‚òë';
            }
            
            // Ensure at least one role is selected
            if (window.selectedUserTypes.length === 0) {
                window.selectedUserTypes = ['buyer'];
                const buyerCard = document.getElementById('buyer-card');
                if (buyerCard) {
                    buyerCard.classList.add('active');
                    const buyerCheckbox = buyerCard.querySelector('.user-type-checkbox');
                    if (buyerCheckbox) {
                        buyerCheckbox.textContent = '‚òë';
                    }
                }
            }
            
            updateRoleSummary();
            updateFormFields();
        };

        function updateRoleSummary() {
            const roleNames = {
                'supplier': 'Data Supplier',
                'reviewer': 'Validator', 
                'buyer': 'Agent/Buyer'
            };
            
            const summary = window.selectedUserTypes.map(type => roleNames[type]).join(' + ');
            const summaryEl = document.getElementById('role-summary');
            if (summaryEl) {
                summaryEl.textContent = summary;
            }
        }

        function updateFormFields() {
            const supplierFields = document.getElementById('supplier-fields');
            const reviewerFields = document.getElementById('reviewer-fields');
            const loginHelp = document.getElementById('login-help');
            
            if (!supplierFields || !reviewerFields || !loginHelp) return;
            
            // Show relevant form fields based on selected roles
            if (window.selectedUserTypes.includes('supplier')) {
                supplierFields.classList.remove('hidden');
            } else {
                supplierFields.classList.add('hidden');
            }
            
            if (window.selectedUserTypes.includes('reviewer')) {
                reviewerFields.classList.remove('hidden');
            } else {
                reviewerFields.classList.add('hidden');
            }
            
            // Update login help text
            if (window.selectedUserTypes.length === 1) {
                const type = window.selectedUserTypes[0];
                if (type === 'supplier') {
                    loginHelp.textContent = 'Enter your supplier API key (sup_...)';
                } else if (type === 'reviewer') {
                    loginHelp.textContent = 'Enter your reviewer API key (rev_...)';
                } else {
                    loginHelp.textContent = 'Enter your agent token or API key';
                }
            } else {
                loginHelp.textContent = 'Enter your master API key or any role-specific key';
            }
        }

        function switchAuthMode(mode) {
            window.authMode = mode;
            
            // Update tab states
            document.getElementById('login-tab').classList.toggle('active', mode === 'login');
            document.getElementById('register-tab').classList.toggle('active', mode === 'register');
            
            // Show/hide panels
            document.getElementById('login-panel').classList.toggle('active', mode === 'login');
            document.getElementById('register-panel').classList.toggle('active', mode === 'register');
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeIcon = document.getElementById('theme-icon');
            
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? '‚òÄ' : '‚òæ';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeIcon = document.getElementById('theme-icon');
            
            document.documentElement.setAttribute('data-theme', newTheme);
            if (themeIcon) {
                themeIcon.textContent = newTheme === 'dark' ? '‚òÄ' : '‚òæ';
            }
            
            localStorage.setItem('theme', newTheme);
        }

        function showMessage(message, type) {
            const className = type === 'error' ? 'error' : 'success';
            const messageEl = document.createElement('div');
            messageEl.className = className;
            messageEl.textContent = message;
            messageEl.style.position = 'fixed';
            messageEl.style.top = '2rem';
            messageEl.style.right = '2rem';
            messageEl.style.zIndex = '1000';
            messageEl.style.minWidth = '200px';
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 5000);
        }

        function showAPIIntegration() {
            alert(`API Integration Examples:\n\n` +
                  `Agents/Buyers:\n` +
                  `1. POST /mint {"agent_id":"bot01","credits":10}\n` +
                  `2. GET /data/package/1 -H "Authorization: Bearer TOKEN"\n\n` +
                  `Suppliers:\n` +
                  `1. POST /suppliers/register\n` +
                  `2. POST /suppliers/packages -H "X-API-Key: sup_..."\n\n` +
                  `Reviewers:\n` +
                  `1. POST /reviewers/register\n` +
                  `2. GET /review-tasks -H "X-API-Key: rev_..."`);
        }

        // Event setup function
        function setupEventListeners() {
            console.log('Setting up event listeners...');

            // User type cards - click handlers
            const cards = ['supplier-card', 'reviewer-card', 'buyer-card'];
            cards.forEach((cardId, index) => {
                const card = document.getElementById(cardId);
                const types = ['supplier', 'reviewer', 'buyer'];
                if (card) {
                    card.addEventListener('click', () => {
                        console.log('Card clicked:', types[index]);
                        window.toggleUserType(types[index]);
                    });
                }
            });

            // Form tabs
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            if (loginTab) loginTab.addEventListener('click', () => switchAuthMode('login'));
            if (registerTab) registerTab.addEventListener('click', () => switchAuthMode('register'));

            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) themeToggle.addEventListener('click', toggleTheme);

            // API integration button
            const apiBtn = document.getElementById('api-integration-btn');
            if (apiBtn) apiBtn.addEventListener('click', showAPIIntegration);

            // Form submissions - REAL functionality
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const apiKey = document.getElementById('login-key').value.trim();
                    
                    if (!apiKey) {
                        showMessage('Please enter your API key', 'error');
                        return;
                    }

                    const btn = loginForm.querySelector('button');
                    btn.disabled = true;
                    btn.textContent = 'Signing in...';

                    try {
                        window.currentUser = {
                            apiKey: apiKey,
                            roles: {},
                            activeRole: null,
                            name: '',
                            email: '',
                            stellar_address: ''
                        };

                        // Try to authenticate with different role endpoints
                        const roleEndpoints = {
                            'supplier': '/suppliers/me',
                            'reviewer': '/reviewers/me'
                        };

                        let authenticatedRoles = [];

                        // Check each role
                        for (const [role, endpoint] of Object.entries(roleEndpoints)) {
                            try {
                                const response = await fetch(`${window.API_BASE}${endpoint}`, {
                                    headers: { 'X-API-Key': apiKey }
                                });

                                if (response.ok) {
                                    const roleData = await response.json();
                                    window.currentUser.roles[role] = roleData;
                                    authenticatedRoles.push(role);
                                    
                                    // Use first successful auth for primary info
                                    if (!window.currentUser.activeRole) {
                                        window.currentUser.activeRole = role;
                                        window.currentUser.name = roleData.name;
                                        window.currentUser.email = roleData.email;
                                        window.currentUser.stellar_address = roleData.stellar_address;
                                    }
                                }
                            } catch (error) {
                                console.log(`No ${role} access for this key`);
                            }
                        }

                        // Check if it's a buyer/agent token
                        if (authenticatedRoles.length === 0) {
                            // Create agent profile
                            window.currentUser = {
                                activeRole: 'buyer',
                                availableRoles: ['buyer'],
                                apiKey: apiKey,
                                name: 'AI Agent',
                                id: 'agent-' + Math.random().toString(36).substr(2, 9),
                                balance: 10.00,
                                roles: {
                                    buyer: {
                                        id: 'agent-' + Math.random().toString(36).substr(2, 9),
                                        balance: 10.00
                                    }
                                }
                            };
                            authenticatedRoles = ['buyer'];
                        }

                        if (authenticatedRoles.length > 0) {
                            window.currentUser.availableRoles = authenticatedRoles;
                            
                            const roleText = authenticatedRoles.length > 1 ? 
                                `${authenticatedRoles.length} roles` : 
                                authenticatedRoles[0];
                            showMessage(`Successfully signed in with ${roleText}!`, 'success');
                        } else {
                            showMessage('Invalid API key or token', 'error');
                        }

                    } catch (error) {
                        showMessage(`Network error: ${error.message}`, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = 'Access Dashboard';
                    }
                });
            }
            
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = {
                        name: document.getElementById('reg-name').value.trim(),
                        email: document.getElementById('reg-email').value.trim(),
                        stellar_address: document.getElementById('reg-stellar').value.trim(),
                    };

                    // Add reviewer-specific fields if reviewer role selected
                    if (window.selectedUserTypes.includes('reviewer')) {
                        const specializations = document.getElementById('reg-specializations').value.trim();
                        formData.specializations = specializations ? specializations.split(',').map(s => s.trim()) : [];
                    }

                    const btn = registerForm.querySelector('button');
                    btn.disabled = true;
                    btn.textContent = 'Creating account...';

                    try {
                        const results = {};
                        let errorOccurred = false;

                        // Register for each selected role
                        for (const userType of window.selectedUserTypes) {
                            if (userType === 'buyer') continue; // Buyers don't need registration, just tokens
                            
                            try {
                                const endpoint = userType === 'supplier' ? '/suppliers/register' : '/reviewers/register';
                                const response = await fetch(`${window.API_BASE}${endpoint}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(formData)
                                });

                                if (response.ok) {
                                    const result = await response.json();
                                    results[userType] = result;
                                } else {
                                    const error = await response.text();
                                    throw new Error(`${userType} registration failed: ${error}`);
                                }
                            } catch (error) {
                                console.error(`Error registering as ${userType}:`, error);
                                errorOccurred = true;
                                showMessage(error.message, 'error');
                            }
                        }

                        if (!errorOccurred && Object.keys(results).length > 0) {
                            // Show all API keys to user
                            let message = 'Account(s) created successfully!\n\n';
                            Object.entries(results).forEach(([role, result]) => {
                                message += `${role.charAt(0).toUpperCase() + role.slice(1)} API Key: ${result.api_key}\n`;
                            });
                            message += '\nPlease save these keys securely - you won\'t see them again.';
                            
                            alert(message);
                            
                            // Use the first API key for automatic login
                            const firstKey = Object.values(results)[0].api_key;
                            switchAuthMode('login');
                            document.getElementById('login-key').value = firstKey;
                            
                            showMessage('Account created! You can now sign in.', 'success');
                        } else if (window.selectedUserTypes.length === 1 && window.selectedUserTypes[0] === 'buyer') {
                            // Special handling for buyer-only accounts
                            showMessage('Buyer account ready! Use the "Mint Tokens" feature to get started.', 'success');
                            switchAuthMode('login');
                        }

                    } catch (error) {
                        showMessage(`Registration error: ${error.message}`, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = 'Create Account';
                    }
                });
            }

            console.log('Event listeners setup complete');
        }

        // Initialize function
        function initialize() {
            console.log('Initializing SquidPro Profile...');
            initializeTheme();
            setupEventListeners();
            
            // Set initial role
            window.toggleUserType('supplier');
            
            console.log('SquidPro Profile initialized successfully!');
            console.log('You can now test: toggleUserType("reviewer")');
        }

        // Make sure function is available globally
        window.initialize = initialize;

        // Multiple initialization approaches
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        // Fallback
        setTimeout(() => {
            if (typeof window.toggleUserType === 'undefined') {
                console.error('toggleUserType still not defined, trying to fix...');
                initialize();
            } else {
                console.log('toggleUserType successfully defined!');
            }
        }, 1000);

        console.log('Script loaded, toggleUserType available:', typeof window.toggleUserType);
    </script>
</body>
</html>